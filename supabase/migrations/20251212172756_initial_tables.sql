CREATE TABLE TbCliente(
    CodCliente BIGINT GENERATED BY DEFAULT AS IDENTITY,
    RazaoSocial VARCHAR(50) NOT NULL,
    Cnpj VARCHAR(14) NOT NULL,
    Situacao CHAR(1) NOT NULL, --1 Ativo, 2 Cancelado, 3 - Em negociação, 4 Prospecção
    Endereco VARCHAR(255) NOT NULL,
    Cep VARCHAR(8) NOT NULL,
    Observacoes TEXT,
    CodIntegracaoApi BIGINT, --Codigo da Api de ADMIN da integração correspondente
    DataCadastro TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    DataUltimaAlteracao TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    PRIMARY KEY(CodCliente)
);

CREATE TABLE TbContatoCliente(
    CodContatoCliente BIGINT GENERATED BY DEFAULT AS IDENTITY,
    CodCliente BIGINT NOT NULL REFERENCES TbCliente(CodCliente),
    Email VARCHAR(100),
    Telefone VARCHAR(20),
    Nome VARCHAR(100),
    DataCadastro TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    DataUltimaAlteracao TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,

    PRIMARY KEY (CodContatoCliente)
);

CREATE TABLE TbParcela(
    CodParcela BIGINT GENERATED BY DEFAULT AS IDENTITY,
    CodCliente BIGINT NOT NULL REFERENCES TbCliente(CodCliente),
    NumParcela INT NOT NULL,
    Valor NUMERIC(12,4) NOT NULL,
    Pago BOOLEAN NOT NULL,
    DataVencimento DATE NOT NULL,
    Tipo CHAR(1) NOT NULL,
    DataCadastro TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    DataUltimaAlteracao TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (CodParcela)
);

CREATE TABLE TbMovimentacao(
    CodMovimentacao BIGINT GENERATED BY DEFAULT AS IDENTITY,
    Descricao VARCHAR(100) NOT NULL,
    Categoria VARCHAR(30) NOT NULL,
    SubCategoria VARCHAR(30) NOT NULL,
    Valor NUMERIC(12,4) NOT NULL,
    DataPagamento DATE NOT NULL,
    CodParcela BIGINT REFERENCES TbParcela(CodParcela), --Caso seja referente a alguma parcela de cliente
    DataCadastro TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    DataUltimaAlteracao TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (CodMovimentacao)
);

CREATE TABLE TbDocumento(
    CodDocumento BIGINT GENERATED BY DEFAULT AS IDENTITY,
    Nome VARCHAR(100) NOT NULL,
    Arquivo BYTEA NOT NULL,
    DataCadastro TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    DataUltimaAlteracao TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY(CodDocumento)
);




CREATE OR REPLACE FUNCTION fn_atualiza_data()
RETURNS TRIGGER AS $$
BEGIN
    NEW.DataUltimaAlteracao = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_atualiza_data_cliente
BEFORE INSERT OR UPDATE ON TbCliente
FOR EACH ROW
EXECUTE FUNCTION fn_atualiza_data();

CREATE TRIGGER trg_atualiza_data_contato_cliente
BEFORE INSERT OR UPDATE ON TbContatoCliente
FOR EACH ROW
EXECUTE FUNCTION fn_atualiza_data();

CREATE TRIGGER trg_atualiza_data_tbparcela
BEFORE INSERT OR UPDATE ON TbParcela
FOR EACH ROW
EXECUTE FUNCTION fn_atualiza_data();

CREATE TRIGGER trg_atualiza_data_tbmovimentacao
BEFORE INSERT OR UPDATE ON TbMovimentacao
FOR EACH ROW
EXECUTE FUNCTION fn_atualiza_data();

CREATE TRIGGER trg_atualiza_data_tbdocumento
BEFORE INSERT OR UPDATE ON TbDocumento
FOR EACH ROW
EXECUTE FUNCTION fn_atualiza_data();